# 大鼓达人 - DAW 专业标注工具使用手册

## 1. 概述

**DAW 专业标注工具** 是为 "大鼓达人" 项目设计的一款基于 Web 的高级音频标注界面。它模仿了专业数字音频工作站 (DAW) 的设计和工作流程，旨在为节奏游戏的 beatmap（谱面）制作者提供一个高效、精确且功能强大的标注环境。

该工具深度集成了项目的后端智能分析服务，包括 **BPM 自动检测**、**节拍网格生成** 和 **一键自动对齐**，极大地提升了标注效率和准确性。

**访问地址**: [http://localhost:5001/daw](http://localhost:5001/daw)

---

## 2. 界面布局

![DAW Interface Layout](URL_to_interface_screenshot)  <!-- 占位符 -->

界面主要分为三个区域：

1.  **顶部标题栏 (Header)**: 显示工具名称和版本号。
2.  **左侧边栏 (Sidebar)**: 包含项目管理、BPM分析、自动对齐和标注列表等核心功能面板。
3.  **主内容区 (Main Content)**:
    *   **工具栏 (Toolbar)**: 包含播放控制、BPM显示、缩放控制和标注工具选择。
    *   **时间轴 (Timeline)**: 包含时间标尺、音频波形轨道和鼓点标注轨道。

---

## 3.核心功能与工作流程

标准的工作流程遵循从上到下的顺序，即 **项目 -> BPM -> 对齐 -> 标注**。

### 3.1. 项目面板 (Project Panel)

这是工作流程的起点。

1.  **选择项目**: 从下拉列表中选择您要处理的歌曲项目。
2.  **加载项目**: 点击 **`加载项目`** 按钮。
    *   系统会自动加载 `data/<项目名>/generated_audio/drums.mp3` 音频文件。
    *   加载完成后，音频波形会显示在主内容区。
    *   系统会自动加载该项目已有的标注文件（如果存在）。

### 3.2. BPM 分析面板 (BPM Analysis)

加载项目后，您需要为音频确定BPM和节拍网格。

1.  **自动检测**: 点击 **`检测 BPM`** 按钮。
    *   系统会调用后端服务，使用多种算法分析音频，并返回最可靠的BPM值和置信度。
    *   检测到的BPM会自动填入“手动BPM”输入框。
2.  **手动输入**: 您也可以直接在 **`手动 BPM`** 输入框中覆盖或输入一个精确的BPM值。
3.  **生成节拍网格**: 确认BPM后，点击 **`生成节拍网格`** 按钮。
    *   系统会根据BPM在音频波形下方生成可视化的小节线。
    *   这些小节线会随着波形的滚动和缩放自动同步。

### 3.3. 自动对齐面板 (Auto-Alignment)

在拥有节拍网格和一些标注后，此功能可以极大地提升效率。

1.  **设置量化模式**: 选择您希望的对齐精度。
    *   **基础模式**: `1/4`, `1/8`, `1/16`
    *   **Swing模式**: `1/8+swing` (带摇摆节奏的八分音符) 等。
    *   **三连音模式**: `1/8T` (八分三连音) 等。
2.  **调整Swing量**: 如果使用Swing模式，可以选择摇摆的程度（轻微/中等/重度）或自定义。
3.  **设置容差**: 定义一个时间窗口，只有落在这个窗口内的标注才会被对齐。
4.  **执行对齐**: 点击 **`自动对齐标注`** 按钮。
    *   所有已存在的标注点会自动吸附到最近的节拍网格线上。
    *   状态栏会显示有多少标注被对齐，以及平均调整了多少毫秒。

### 3.4. 标注面板 (Annotations)

这里是手动添加和管理鼓点标注的地方。

#### 添加标注

1.  **选择工具**: 在主内容区的工具栏中，选择 **`咚`** (Don) 或 **`咔`** (Ka) 工具。
2.  **点击添加**: 在下方的 **标注轨道 (Annotation Track)** 上单击，即可在当前时间点添加一个对应类型的鼓点。
3.  **快捷键**:
    *   按 **`D`** 键，在当前播放头位置添加一个 "Don"。
    *   按 **`K`** 键，在当前播放头位置添加一个 "Ka"。

#### 编辑与删除

1.  **选择标注**: 点击标注轨道上的鼓点标记，或标注列表中的条目来选中它。
2.  **拖动修改**: 在 **波形轨道** 上，可以直接拖动标注区域的左右边缘来调整其开始时间和持续时长。
3.  **删除标注**: 选中一个标注后，按 **`Delete`** 或 **`Backspace`** 键将其删除。也可以点击标注列表项右侧的删除按钮。

#### 保存与导出

1.  **保存进度**: 点击 **`保存标注`** 按钮，将当前所有标注信息保存到服务器。
2.  **导出样本**: 点击 **`导出音频样本`** 按钮，将标注数据发送到后端进行处理。

---

## 4. 快捷键与高级操作

### 播放控制
- **`空格键`**: 播放 / 暂停

### 缩放控制
- **`Ctrl/Cmd` + `鼠标滚轮`**: 在波形图上进行缩放。
- **工具栏按钮**: 使用 `+` / `-` 按钮进行步进缩放，使用 `⊟` 按钮适应窗口大小。

### 标注操作
- **`D`**: 添加 "Don"
- **`K`**: 添加 "Ka"
- **`Delete` / `Backspace`**: 删除选中的标注
- **`Ctrl/Cmd` + `S`**: 保存当前所有标注

---

## 5. 技术细节

- **前端库**: WaveSurfer.js v7
- **核心逻辑**: 原生 JavaScript (ES6+)
- **后端通信**: 通过 Fetch API 与 Flask RESTful 服务进行异步通信。

该界面目前已经完成了核心功能的设计与开发，并通过了初步的功能调试。

## 6. 下一步计划 (Phase 5)

- **集成与测试**:
  - 对所有功能进行全面的端到端测试。
  - 修复潜在的边界情况和Bug。
- **性能优化**:
  - 优化大量标注点存在时的渲染性能。
- **用户体验增强**:
  - 添加时间码和节拍号显示。
  - 增加右键菜单等高级交互。
- **文档完善**:
  - 补充API接口文档和部署说明。