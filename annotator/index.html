<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音频标注工具 V5.1 (项目版)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2em; background-color: #f4f4f9; color: #333; }
        #app { max-width: 900px; margin: auto; background: white; padding: 2em; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #4a4a4a; }
        .controls, .file-loader, .section-box { text-align: center; margin-bottom: 1.5em; }
        button { font-size: 1em; padding: 0.6em 1.2em; margin: 0 0.5em; border: none; border-radius: 5px; background-color: #007bff; color: white; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #export-btn { background-color: #28a745; }
        #save-btn { background-color: #ffc107; color: #212529;}
        #waveform { border: 1px solid #ddd; border-radius: 5px; }
        #loading { text-align: center; display: none; margin-top: 1em; color: #555; }
        .section-box { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 1.5em; text-align: left; margin-top: 2em; }
        .section-box h3 { margin-top: 0; }
        .section-box code { background-color: #e9ecef; padding: 0.2em 0.4em; border-radius: 3px; }
        #annotations-list { list-style-type: none; padding: 0; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; }
        #annotations-list li { padding: 0.8em; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .delete-btn { background-color: #dc3545; color: white; padding: 0.3em 0.8em; border-radius: 4px; cursor: pointer; }
        #selection-arrow {
            position: absolute;
            top: 0;
            left: 50%;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #0d6efd;
            z-index: 11;
            pointer-events: none;
            transition: opacity 0.1s ease-in-out, left 0.05s linear;
            opacity: 0;
            transform: translateX(-50%);
        }
        [data-id].selected-region {
            border-left: 3px solid rgba(13, 110, 253, 0.85);
            border-right: 3px solid rgba(13, 110, 253, 0.85);
            box-sizing: border-box;
            z-index: 10 !important;
        }
        #annotations-list li.selected-annotation {
            background-color: #e7f1ff;
            border-left: 4px solid #0d6efd;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>音频标注工具 V5.1 (项目版)</h1>
        <div class="section-box">
            <h3>1. 选择项目</h3>
            <p>从下方列表中选择一个项目开始标注。</p>
            <div style="display: flex; align-items: center; justify-content: center;">
                <select id="project-selector" style="font-size: 1em; padding: 0.4em; flex-grow: 1; max-width: 400px;"></select>
                <button id="load-project-btn" style="margin-left: 1em;">加载项目</button>
            </div>
            <p id="load-status" style="margin-top: 1em; color: #555;"></p>
        </div>
        <div id="waveform-container" style="position: relative;">
            <div id="selection-arrow"></div>
            <div id="waveform"></div>
        </div>
        <div id="loading">正在加载并绘制波形...</div>
        <div class="controls">
            <button id="play-btn" disabled>播放/暂停</button>
            <button id="zoom-in-btn" disabled>放大 (+)</button>
            <button id="zoom-out-btn" disabled>缩小 (-)</button>
        </div>
        <div class="section-box">
            <h3>2. 进行标注</h3>
            <p>快捷键：<code>Space</code> 播放/暂停, <code>D</code>/<code>K</code> 键在当前播放位置添加标注, 鼠标滚轮缩放波形。点击一个已存在的区域来选中它，然后使用 <code>S</code> 键播放选中区域, 或使用 <code>Backspace</code>/<code>Delete</code> 键删除它。</p>
            <p>图例: <span style="background-color: rgba(255, 99, 71, 0.3); padding: 2px 5px; border-radius: 3px;">Don (咚)</span>
                <span style="background-color: rgba(65, 105, 225, 0.3); padding: 2px 5px; border-radius: 3px; margin-left: 10px;">Ka (咔)</span>
            </p>
        </div>
        <div id="annotations-container" class="section-box">
            <h3>已标注的鼓点:</h3>
            <ul id="annotations-list"></ul>
        </div>
        <div class="section-box">
            <h3>3. 保存进度</h3>
            <button id="save-btn" disabled>保存标注到服务器</button>
            <p id="save-status" style="margin-top: 1em; color: #555;"></p>
        </div>
        <div class="section-box">
            <h3>4. 导出</h3>
            <p>完成标注后，点击下方按钮将剪辑任务发送到本地Python服务器进行处理。</p>
            <button id="export-btn" disabled>发送到服务器处理</button>
            <p id="export-status" style="margin-top: 1em; color: #555;"></p>
        </div>
    </div>

    <script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.min.js"></script>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const projectSelector = document.getElementById('project-selector');
            const loadProjectBtn = document.getElementById('load-project-btn');
            const loadStatus = document.getElementById('load-status');
            const playBtn = document.getElementById('play-btn');
            const zoomInBtn = document.getElementById('zoom-in-btn');
            const zoomOutBtn = document.getElementById('zoom-out-btn');
            const exportBtn = document.getElementById('export-btn');
            const exportStatus = document.getElementById('export-status');
            const saveBtn = document.getElementById('save-btn');
            const saveStatus = document.getElementById('save-status');
            const waveformDiv = document.getElementById('waveform');
            const loadingIndicator = document.getElementById('loading');
            const annotationsList = document.getElementById('annotations-list');
            const selectionArrow = document.getElementById('selection-arrow');

            let annotations = [];
            let originalAudioFileName = '';
            let currentZoomLevel = 100;
            let selectedRegion = null;
            let currentProject = '';
            let isRegionPlayback = false;

            const wavesurfer = WaveSurfer.create({ container: waveformDiv, waveColor: 'rgb(200, 200, 200)', progressColor: 'rgb(100, 100, 100)', cursorWidth: 2, barWidth: 3, barRadius: 3, responsive: true, height: 150, barGap: 3 });
            const wsRegions = wavesurfer.registerPlugin(WaveSurfer.Regions.create());

            // --- Arrow Position Logic ---
            const updateArrowPosition = () => {
                if (!selectedRegion || !selectedRegion.element) {
                    selectionArrow.style.opacity = '0';
                    return;
                }
                const regionEl = selectedRegion.element;
                const regionRect = regionEl.getBoundingClientRect();
                const waveformRect = waveformDiv.getBoundingClientRect();
                const arrowLeft = (regionRect.left - waveformRect.left) + (regionRect.width / 2);
                if (regionRect.right > waveformRect.left && regionRect.left < waveformRect.right) {
                    selectionArrow.style.left = `${arrowLeft}px`;
                    selectionArrow.style.opacity = '1';
                } else {
                    selectionArrow.style.opacity = '0';
                }
            };

            // --- Wheel Zoom & Pan Logic ---
            waveformDiv.addEventListener('wheel', (event) => {
                if (wavesurfer.getDuration() === 0) return;
                event.preventDefault();
                const scrollSensitivity = 5;
                const isHorizontalScroll = Math.abs(event.deltaX) > Math.abs(event.deltaY);
                if (isHorizontalScroll || event.shiftKey) {
                    const panDelta = event.shiftKey ? event.deltaY : event.deltaX;
                    wavesurfer.getWrapper().scrollLeft += panDelta * scrollSensitivity;
                } else {
                    const zoomFactor = event.deltaY < 0 ? 1.2 : 0.8;
                    currentZoomLevel *= zoomFactor;
                    wavesurfer.zoom(currentZoomLevel);
                }
            });
            
            // --- Selection Logic ---
            const clearSelection = () => {
                wsRegions.getRegions().forEach(region => {
                    if (region.element) region.element.classList.remove('selected-region');
                });
                document.querySelectorAll('#annotations-list li').forEach(li => {
                    li.classList.remove('selected-annotation');
                });
                selectedRegion = null;
                updateArrowPosition();
            };
            const selectRegion = (region) => {
                clearSelection();
                selectedRegion = region;
                if (region && region.element) {
                    region.element.classList.add('selected-region');
                    const correspondingLi = document.querySelector(`#annotations-list li[data-id="${region.id}"]`);
                    if (correspondingLi) {
                        correspondingLi.classList.add('selected-annotation');
                    }
                }
                updateArrowPosition();
            };
            wsRegions.on('region-clicked', (region, e) => { e.stopPropagation(); selectRegion(region); });
            wavesurfer.on('interaction', () => clearSelection());
            wavesurfer.on('click', () => clearSelection());

            // --- Project Loading ---
            async function loadProjects() {
                try {
                    const response = await fetch('/api/projects');
                    if (!response.ok) throw new Error('无法从服务器获取项目列表。');
                    const data = await response.json();
                    if (data.status === 'success') {
                        projectSelector.innerHTML = '<option value="">-- 请选择一个项目 --</option>';
                        data.projects.forEach(project => {
                            const option = document.createElement('option');
                            option.value = project;
                            option.textContent = project;
                            projectSelector.appendChild(option);
                        });
                    } else { throw new Error(data.message); }
                } catch (error) {
                    loadStatus.textContent = `Error: ${error.message}`;
                    loadStatus.style.color = '#dc3545';
                }
            }

            async function loadAnnotations(projectName) {
                try {
                    const response = await fetch(`/api/annotations/${projectName}`);
                    if (!response.ok) throw new Error('无法获取标注。');
                    const data = await response.json();
                    if (data.status === 'success') {
                        annotations = data.annotations;
                        if (annotations.length > 0) {
                             loadStatus.textContent += ` 已找到 ${annotations.length} 个存在的标注。`;
                        }
                        wsRegions.clearRegions();
                        annotations.forEach(addRegion);
                        renderAnnotationsList();
                    } else { throw new Error(data.message); }
                } catch (error) {
                    loadStatus.textContent += ` 警告: ${error.message}`;
                    loadStatus.style.color = '#ffc107';
                }
            }

            loadProjectBtn.addEventListener('click', () => {
                const selectedProject = projectSelector.value;
                if (!selectedProject) {
                    loadStatus.textContent = '请先选择一个项目。';
                    loadStatus.style.color = '#dc3545';
                    return;
                }
                currentProject = selectedProject;
                const audioFilePath = `data/${currentProject}/generated_audio/drums.mp3`;
                
                loadStatus.textContent = `正在加载 ${audioFilePath}...`;
                loadStatus.style.color = '#555';

                fetch(audioFilePath)
                    .then(response => {
                        if (!response.ok) throw new Error(`找不到音频文件。请确保 '${audioFilePath}' 存在。`);
                        return response.blob();
                    })
                    .then(audioBlob => {
                        resetState();
                        loadingIndicator.style.display = 'block';
                        waveformDiv.style.display = 'none';
                        originalAudioFileName = 'drums.mp3';
                        wavesurfer.load(URL.createObjectURL(audioBlob));
                    })
                    .catch(error => {
                        loadStatus.textContent = `加载失败: ${error.message}`;
                        loadStatus.style.color = '#dc3545';
                    });
            });

            const resetState = () => {
                clearSelection();
                annotations = [];
                wsRegions.clearRegions();
                renderAnnotationsList();
                playBtn.disabled = true;
                zoomInBtn.disabled = true;
                zoomOutBtn.disabled = true;
                exportBtn.disabled = true;
                saveBtn.disabled = true;
                saveStatus.textContent = '';
                exportStatus.textContent = '';
            };
            
            playBtn.addEventListener('click', () => wavesurfer.playPause());
            zoomInBtn.addEventListener('click', () => { currentZoomLevel *= 1.5; wavesurfer.zoom(currentZoomLevel); });
            zoomOutBtn.addEventListener('click', () => { currentZoomLevel /= 1.5; wavesurfer.zoom(currentZoomLevel); });

            wavesurfer.on('ready', () => {
                wavesurfer.getWrapper().addEventListener('scroll', updateArrowPosition);
                loadingIndicator.style.display = 'none';
                waveformDiv.style.display = 'block';
                playBtn.disabled = false;
                zoomInBtn.disabled = false;
                zoomOutBtn.disabled = false;
                currentZoomLevel = 100;
                wavesurfer.zoom(currentZoomLevel);
                loadStatus.textContent = `项目 '${currentProject}' 加载成功。正在检查已保存的标注...`;
                loadStatus.style.color = '#28a745';
                loadAnnotations(currentProject);
            });
            wavesurfer.on('zoom', updateArrowPosition);
            wavesurfer.on('redraw', updateArrowPosition);

            const addAnnotation = (type) => {
                if (wavesurfer.getDuration() === 0) return;
                const currentTime = wavesurfer.getCurrentTime();
                const newAnnotation = { id: `ann-${Date.now()}`, time: currentTime, duration: 0.1, type };
                annotations.push(newAnnotation);
                const newRegion = addRegion(newAnnotation);
                renderAnnotationsList();
                selectRegion(newRegion);
            };

            const addRegion = (ann) => {
                return wsRegions.addRegion({
                    id: ann.id, start: ann.time, end: ann.time + ann.duration,
                    color: ann.type === 'don' ? 'rgba(255, 99, 71, 0.3)' : 'rgba(65, 105, 225, 0.3)',
                    drag: true, resize: true,
                });
            };

            wsRegions.on('region-updated', (region) => {
                const ann = annotations.find(a => a.id === region.id);
                if (ann) { 
                    ann.time = region.start; 
                    ann.duration = region.end - region.start; 
                    renderAnnotationsList(); 
                    updateArrowPosition();
                }
            });

            wavesurfer.on('pause', () => { isRegionPlayback = false; });
            wavesurfer.on('audioprocess', (currentTime) => {
                if (isRegionPlayback && selectedRegion && currentTime >= selectedRegion.end) {
                    wavesurfer.pause();
                    wavesurfer.seekTo(selectedRegion.end / wavesurfer.getDuration());
                }
                updateArrowPosition();
            });

            document.addEventListener('keydown', (e) => {
                 if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
                 e.preventDefault(); 
                 const key = e.key.toLowerCase();
                 if (key === 'd') addAnnotation('don');
                 else if (key === 'k') addAnnotation('ka');
                 else if (key === ' ') wavesurfer.playPause();
                 else if (key === 's' && selectedRegion) {
                     isRegionPlayback = true;
                     wavesurfer.play(selectedRegion.start);
                 } else if ((key === 'backspace' || key === 'delete') && selectedRegion) {
                     selectedRegion.remove();
                 }
            });
            
            annotationsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const idToDelete = e.target.getAttribute('data-id');
                    const region = wsRegions.getRegions().find(r => r.id === idToDelete);
                    if (region) region.remove();
                    return; 
                }
                const li = e.target.closest('li');
                if (li && li.dataset.id) {
                    const regionToSelect = wsRegions.getRegions().find(r => r.id === li.dataset.id);
                    if (regionToSelect) {
                        selectRegion(regionToSelect);
                        wavesurfer.seekTo(regionToSelect.start / wavesurfer.getDuration());
                    }
                }
            });

             wsRegions.on('region-removed', (region) => {
                annotations = annotations.filter(ann => ann.id !== region.id);
                if (selectedRegion && selectedRegion.id === region.id) {
                    clearSelection();
                }
                renderAnnotationsList();
            });

            const renderAnnotationsList = () => {
                annotationsList.innerHTML = '';
                const hasAnnotations = annotations.length > 0;
                exportBtn.disabled = !hasAnnotations;
                saveBtn.disabled = !hasAnnotations;
                if (!hasAnnotations) { annotationsList.innerHTML = '<li>暂无标注</li>'; return; }
                annotations.sort((a, b) => a.time - b.time);
                annotations.forEach(ann => {
                    const li = document.createElement('li');
                    li.dataset.id = ann.id; 
                    li.innerHTML = `<span><strong>${ann.type.toUpperCase()}</strong> @ ${ann.time.toFixed(3)}s (持续 ${ann.duration.toFixed(3)}s)</span> <button class="delete-btn" data-id="${ann.id}">删除</button>`;
                    if (selectedRegion && ann.id === selectedRegion.id) {
                        li.classList.add('selected-annotation');
                    }
                    annotationsList.appendChild(li);
                });
            };

            saveBtn.addEventListener('click', async () => {
                if (!currentProject) {
                    saveStatus.textContent = '错误：请先加载一个项目。';
                    saveStatus.style.color = '#dc3545';
                    return;
                }
                saveStatus.textContent = '正在保存到服务器...';
                saveStatus.style.color = '#007bff';
                saveBtn.disabled = true;
                try {
                    const response = await fetch(`/api/annotations/${currentProject}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ annotations: annotations })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        saveStatus.textContent = `成功！${result.message}`;
                        saveStatus.style.color = '#28a745';
                    } else { throw new Error(result.message || 'Unknown server error'); }
                } catch (error) {
                    saveStatus.textContent = `保存失败: ${error.message}`;
                    saveStatus.style.color = '#dc3545';
                } finally {
                    saveBtn.disabled = false;
                }
            });

            exportBtn.addEventListener('click', async () => {
                if (!currentProject) {
                    exportStatus.textContent = '错误：请先加载一个项目。';
                    exportStatus.style.color = '#dc3545';
                    return;
                }
                exportStatus.textContent = '正在发送数据到服务器...';
                exportStatus.style.color = '#007bff';
                exportBtn.disabled = true;
                try {
                    const response = await fetch('/process', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            projectName: currentProject, // Changed from projectPath
                            audioFile: originalAudioFileName,
                            annotations: annotations
                        })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        exportStatus.textContent = `成功！${result.message}`;
                        exportStatus.style.color = '#28a745';
                    } else { throw new Error(result.message || 'Unknown server error'); }
                } catch (error) {
                    exportStatus.textContent = `导出失败: ${error.message}。Python 服务器正在运行吗？`;
                    exportStatus.style.color = '#dc3545';
                } finally {
                    exportBtn.disabled = false;
                }
            });
            
            // Initial load of project list
            loadProjects();
        });
    </script>
</body>
</html>
