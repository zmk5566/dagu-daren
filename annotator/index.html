<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音频标注工具 V2.4</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2em; background-color: #f4f4f9; color: #333; }
        #app { max-width: 900px; margin: auto; background: white; padding: 2em; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #4a4a4a; }
        .controls, .file-loader, .section-box { text-align: center; margin-bottom: 1.5em; }
        button { font-size: 1em; padding: 0.6em 1.2em; margin: 0 0.5em; border: none; border-radius: 5px; background-color: #007bff; color: white; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #export-btn { background-color: #28a745; }
        #save-btn { background-color: #ffc107; color: #212529;}
        #waveform { border: 1px solid #ddd; border-radius: 5px; }
        #loading { text-align: center; display: none; margin-top: 1em; color: #555; }
        input[type="file"], input[type="text"] { font-size: 1em; padding: 0.4em; }
        input[type="text"] { width: 95%; margin-top: 0.5em; }
        .section-box { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 1.5em; text-align: left; margin-top: 2em; }
        .section-box h3 { margin-top: 0; }
        .section-box code { background-color: #e9ecef; padding: 0.2em 0.4em; border-radius: 3px; }
        #annotations-list { list-style-type: none; padding: 0; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; }
        #annotations-list li { padding: 0.8em; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .delete-btn { background-color: #dc3545; color: white; padding: 0.3em 0.8em; border-radius: 4px; cursor: pointer; }
        #selection-arrow {
            position: absolute;
            top: 0; /* Position it at the top of the waveform container */
            left: 50%; /* Will be dynamically updated */
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #0d6efd; /* Arrow color */
            z-index: 11; /* Above the selected region highlight */
            pointer-events: none; /* Make it non-interactive */
            transition: opacity 0.1s ease-in-out, left 0.05s linear;
            opacity: 0;
            transform: translateX(-50%); /* Center the arrow precisely */
        }
        [data-id].selected-region {
            /* Blue side borders for selection highlight */
            border-left: 3px solid rgba(13, 110, 253, 0.85);
            border-right: 3px solid rgba(13, 110, 253, 0.85);
            box-sizing: border-box; /* Ensure borders don't increase region width */
            z-index: 10 !important;
        }
        #annotations-list li.selected-annotation {
            background-color: #e7f1ff;
            border-left: 4px solid #0d6efd;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>音频标注工具 V2.4</h1>
        <div class="section-box">
             <h3>1. 加载文件</h3>
            <p><strong>步骤 1.1:</strong> 选择要标注的音频文件 (例如 `drums.mp3`):</p>
            <input type="file" id="audio-file" accept="audio/*">
            <p style="margin-top: 1em;"><strong>步骤 1.2:</strong> 输入该音频所在的项目文件夹路径:</p>
            <input type="text" id="project-path" placeholder="例如: data/xwx-backtrack-n-drum/generated_audio">
        </div>
        <div id="waveform-container" style="position: relative;">
            <div id="selection-arrow"></div>
            <div id="waveform"></div>
        </div>
        <div id="loading">正在加载并绘制波形...</div>
        <div class="controls">
            <button id="play-btn" disabled>播放/暂停</button>
            <button id="zoom-in-btn" disabled>放大 (+)</button>
            <button id="zoom-out-btn" disabled>缩小 (-)</button>
        </div>
        <div class="section-box">
            <h3>2. 进行标注</h3>
            <p>快捷键：<code>Space</code> 播放/暂停, <code>D</code>/<code>K</code> 键标注, 鼠标滚轮缩放。点击区域可选中，<code>S</code> 播放选中, <code>Backspace</code> 删除选中。</p>
            <p>图例: <span style="background-color: rgba(255, 99, 71, 0.3); padding: 2px 5px; border-radius: 3px;">Don (咚)</span>
                <span style="background-color: rgba(65, 105, 225, 0.3); padding: 2px 5px; border-radius: 3px; margin-left: 10px;">Ka (咔)</span>
            </p>
        </div>
        <div id="annotations-container" class="section-box">
            <h3>已标注的鼓点:</h3>
            <ul id="annotations-list"></ul>
        </div>
        <div class="section-box">
            <h3>3. 保存或加载进度 (可选)</h3>
            <button id="save-btn" disabled>保存标注到 JSON</button>
            <input type="file" id="load-btn" accept=".json" style="margin-left: 1em;">
        </div>
        <div class="section-box">
            <h3>4. 导出</h3>
            <p>完成标注后，生成剪辑脚本。下载后请从项目根目录运行它。</p>
            <button id="export-btn" disabled>生成剪辑脚本</button>
        </div>
    </div>

    <script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.min.js"></script>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('audio-file');
            const projectPathInput = document.getElementById('project-path');
            const playBtn = document.getElementById('play-btn');
            const zoomInBtn = document.getElementById('zoom-in-btn');
            const zoomOutBtn = document.getElementById('zoom-out-btn');
            const exportBtn = document.getElementById('export-btn');
            const saveBtn = document.getElementById('save-btn');
            const loadInput = document.getElementById('load-btn');
            const waveformDiv = document.getElementById('waveform');
            const loadingIndicator = document.getElementById('loading');
            const annotationsList = document.getElementById('annotations-list');
            const selectionArrow = document.getElementById('selection-arrow');

            let annotations = [];
            let originalAudioFileName = '';
            let currentZoomLevel = 50;
            let selectedRegion = null;
            let isRegionPlayback = false;

            const wavesurfer = WaveSurfer.create({ container: waveformDiv, waveColor: 'rgb(200, 200, 200)', progressColor: 'rgb(100, 100, 100)', cursorWidth: 2, barWidth: 3, barRadius: 3, responsive: true, height: 150, barGap: 3 });
            const wsRegions = wavesurfer.registerPlugin(WaveSurfer.Regions.create());

            // --- Arrow Position Logic ---
            const updateArrowPosition = () => {
                if (!selectedRegion || !selectedRegion.element) {
                    selectionArrow.style.opacity = '0';
                    return;
                }
                const regionEl = selectedRegion.element;
                const regionRect = regionEl.getBoundingClientRect();
                const waveformRect = waveformDiv.getBoundingClientRect();

                const arrowLeft = (regionRect.left - waveformRect.left) + (regionRect.width / 2);
                
                if (regionRect.right > waveformRect.left && regionRect.left < waveformRect.right) {
                    selectionArrow.style.left = `${arrowLeft}px`;
                    selectionArrow.style.opacity = '1';
                } else {
                    selectionArrow.style.opacity = '0';
                }
            };

            // --- Wheel Zoom & Pan Logic ---
            waveformDiv.addEventListener('wheel', (event) => {
                if (wavesurfer.getDuration() === 0) return;
                event.preventDefault();

                const scrollSensitivity = 5;
                const isHorizontalScroll = Math.abs(event.deltaX) > Math.abs(event.deltaY);

                if (isHorizontalScroll || event.shiftKey) {
                    const panDelta = event.shiftKey ? event.deltaY : event.deltaX;
                    wavesurfer.getWrapper().scrollLeft += panDelta * scrollSensitivity;
                } else {
                    const zoomFactor = event.deltaY < 0 ? 1.2 : 0.8;
                    currentZoomLevel *= zoomFactor;
                    wavesurfer.zoom(currentZoomLevel);
                }
            });
            
            // --- Selection Logic ---
            const clearSelection = () => {
                wsRegions.getRegions().forEach(region => {
                    if (region.element) region.element.classList.remove('selected-region');
                });
                document.querySelectorAll('#annotations-list li').forEach(li => {
                    li.classList.remove('selected-annotation');
                });
                selectedRegion = null;
                updateArrowPosition(); // Hide the arrow
            };
            const selectRegion = (region) => {
                clearSelection();
                selectedRegion = region;
                if (region && region.element) {
                    region.element.classList.add('selected-region');
                    const correspondingLi = document.querySelector(`#annotations-list li[data-id="${region.id}"]`);
                    if (correspondingLi) {
                        correspondingLi.classList.add('selected-annotation');
                    }
                }
                updateArrowPosition(); // Show and position the arrow
            };
            wsRegions.on('region-clicked', (region, e) => { e.stopPropagation(); selectRegion(region); });
            wavesurfer.on('interaction', () => clearSelection());
            wavesurfer.on('click', () => clearSelection());

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0]; if (!file) return;
                originalAudioFileName = file.name;
                resetState();
                loadingIndicator.style.display = 'block';
                waveformDiv.style.display = 'none';
                wavesurfer.load(URL.createObjectURL(file));
            });

            const resetState = () => {
                clearSelection(); annotations = []; wsRegions.clearRegions(); renderAnnotationsList();
                playBtn.disabled = true; zoomInBtn.disabled = true; zoomOutBtn.disabled = true;
                exportBtn.disabled = true; saveBtn.disabled = true;
            };
            
            playBtn.addEventListener('click', () => wavesurfer.playPause());
            zoomInBtn.addEventListener('click', () => { currentZoomLevel *= 1.5; wavesurfer.zoom(currentZoomLevel); });
            zoomOutBtn.addEventListener('click', () => { currentZoomLevel /= 1.5; wavesurfer.zoom(currentZoomLevel); });

            wavesurfer.on('ready', () => {
                wavesurfer.getWrapper().addEventListener('scroll', updateArrowPosition);
                loadingIndicator.style.display = 'none'; 
                waveformDiv.style.display = 'block';
                playBtn.disabled = false; 
                zoomInBtn.disabled = false; 
                zoomOutBtn.disabled = false;
                const duration = wavesurfer.getDuration();
                currentZoomLevel = waveformDiv.clientWidth / duration;
                wavesurfer.zoom(currentZoomLevel);
            });
            wavesurfer.on('zoom', updateArrowPosition);
            wavesurfer.on('redraw', updateArrowPosition);

            const addAnnotation = (type) => {
                if (wavesurfer.getDuration() === 0) return;
                const currentTime = wavesurfer.getCurrentTime();
                const duration = 0.1;
                const newAnnotation = { id: `ann-${Date.now()}`, time: currentTime, duration: duration, type };
                annotations.push(newAnnotation);
                const newRegion = addRegion(newAnnotation);
                renderAnnotationsList();
                selectRegion(newRegion);
            };

            const addRegion = (ann) => {
                return wsRegions.addRegion({
                    id: ann.id, start: ann.time, end: ann.time + ann.duration,
                    color: ann.type === 'don' ? 'rgba(255, 99, 71, 0.3)' : 'rgba(65, 105, 225, 0.3)',
                    drag: true, resize: true,
                });
            };

            wsRegions.on('region-updated', (region) => {
                const ann = annotations.find(a => a.id === region.id);
                if (ann) { 
                    ann.time = region.start; 
                    ann.duration = region.end - region.start; 
                    renderAnnotationsList(); 
                    updateArrowPosition(); // Keep arrow in sync while dragging/resizing
                }
            });

            // --- Playback Control Logic ---
            wavesurfer.on('pause', () => {
                isRegionPlayback = false; 
            });

            wavesurfer.on('audioprocess', (currentTime) => {
                // Custom logic to stop playback at the end of a region
                if (isRegionPlayback && selectedRegion && currentTime >= selectedRegion.end) {
                    wavesurfer.pause();
                    // Ensure cursor is visually at the end of the region
                    wavesurfer.seekTo(selectedRegion.end / wavesurfer.getDuration());
                }
                updateArrowPosition(); // Continuously update arrow during playback
            });

            document.addEventListener('keydown', (e) => {
                 if (e.target.tagName === 'INPUT') return;
                 e.preventDefault(); 

                 const key = e.key.toLowerCase();

                 if (key === 'd') {
                     addAnnotation('don');
                 } else if (key === 'k') {
                     addAnnotation('ka');
                 } else if (key === ' ') {
                     wavesurfer.playPause();
                 } else if (key === 's') {
                     if (selectedRegion) {
                         isRegionPlayback = true;
                         wavesurfer.play(selectedRegion.start);
                     }
                 } else if (key === 'backspace' || key === 'delete') {
                     if (selectedRegion) {
                         selectedRegion.remove();
                     }
                 }
            });
            
            annotationsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const idToDelete = e.target.getAttribute('data-id');
                    const region = wsRegions.getRegions().find(r => r.id === idToDelete);
                    if (region) region.remove();
                    return; 
                }

                const li = e.target.closest('li');
                if (li && li.dataset.id) {
                    const regionToSelect = wsRegions.getRegions().find(r => r.id === li.dataset.id);
                    if (regionToSelect) {
                        selectRegion(regionToSelect);
                        wavesurfer.seekTo(regionToSelect.start / wavesurfer.getDuration());
                    }
                }
            });

             wsRegions.on('region-removed', (region) => {
                annotations = annotations.filter(ann => ann.id !== region.id);
                if (selectedRegion && selectedRegion.id === region.id) {
                    clearSelection();
                }
                renderAnnotationsList();
            });

            const renderAnnotationsList = () => {
                annotationsList.innerHTML = '';
                const hasAnnotations = annotations.length > 0;
                exportBtn.disabled = !hasAnnotations; saveBtn.disabled = !hasAnnotations;
                if (!hasAnnotations) { annotationsList.innerHTML = '<li>暂无标注</li>'; return; }
                annotations.sort((a, b) => a.time - b.time);
                annotations.forEach(ann => {
                    const li = document.createElement('li');
                    li.dataset.id = ann.id; 
                    li.innerHTML = `<span><strong>${ann.type.toUpperCase()}</strong> @ ${ann.time.toFixed(3)}s (持续 ${ann.duration.toFixed(3)}s)</span> <button class="delete-btn" data-id="${ann.id}">删除</button>`;
                    if (selectedRegion && ann.id === selectedRegion.id) {
                        li.classList.add('selected-annotation');
                    }
                    annotationsList.appendChild(li);
                });
            };

            saveBtn.addEventListener('click', () => { /* ... (implementation) */ });
            loadInput.addEventListener('change', (event) => { /* ... (implementation) */ });
            exportBtn.addEventListener('click', () => { /* ... (implementation) */ });
            
            resetState();
        });
    </script>
</body>
</html>
